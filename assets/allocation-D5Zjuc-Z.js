import{i as Ne}from"./navigation-CXrC8Ner.js";import{f as ve,g as Ce,b as Ae,d as Se,a as Ie,e as Le}from"./problemView-DNxSRx9J.js";function M(e){let t=0;const n={};for(const[o,c]of Object.entries(e??{})){const l=Number(c);Number.isFinite(l)&&l>=0&&(n[o]=l,t+=l)}if(t<=0)return{valid:!1,weights:{}};const r={};Object.entries(n).forEach(([o,c])=>{r[o]=c/t});const i=Object.values(r).reduce((o,c)=>o+c,0);return{valid:Math.abs(i-1)<1e-6,weights:r}}function $e(e,t,n,r){if(!Number.isFinite(e)||e<=0)throw new Error("startCapital must be positive");if(!Number.isInteger(r)||r<0)throw new Error("startIndex must be a non-negative integer");const i={};for(const[s,o]of Object.entries(t??{})){if(!Number.isFinite(o)||o<=0)continue;const c=n==null?void 0:n[s];if(!Array.isArray(c))throw new Error(`missing price series for ${s}`);const l=Number(c[r]);if(!Number.isFinite(l)||l<=0)throw new Error(`invalid price for ${s} on index ${r}`);i[s]=e*o/l}if(Object.keys(i).length===0)throw new Error("no positions created from weights");return i}function Pe(e,t,n){if(!Number.isInteger(n)||n<0)throw new Error("dayIndex must be a non-negative integer");let r=0;for(const[i,s]of Object.entries(e??{})){if(!Number.isFinite(s)||s<0)throw new Error(`invalid amount for ${i}`);const o=t==null?void 0:t[i];if(!Array.isArray(o))throw new Error(`missing price series for ${i}`);const c=Number(o[n]);if(!Number.isFinite(c))throw new Error(`invalid price for ${i} on index ${n}`);r+=s*c}return r}function Te(e,t,n,r,i,s){if(!e||!Array.isArray(e.days))throw new Error("invalid problem data");if(!Number.isInteger(t)||!Number.isInteger(n))throw new Error("startIndex and endIndex must be integers");if(t<0||n>=e.days.length)throw new Error("index range out of bounds");if(n<t)throw new Error("endIndex must be >= startIndex");const o=s??e.price_in_constant_usd;if(!o||typeof o!="object")throw new Error("missing price data for simulation");const c=$e(r,i,o,t),l=[],a=[],u=[];for(let d=t;d<=n;d+=1){const h=Pe(c,o,d);l.push(d),a.push(e.days[d]),u.push(h)}return{dayIndexes:l,days:a,values:u}}function ke(e,t,n,r,i,s,o){var l;if(!Number.isInteger(s)||s<=0)return[];if(!Number.isInteger(r)||!Number.isInteger(i))return[];if(r<0||i>=(((l=e==null?void 0:e.days)==null?void 0:l.length)??0))return[];if(!e||!Array.isArray(e.days))return[];const c=[];for(let a=r;a<i-s;a+=1){const{dayIndexes:u,days:d,values:h}=Te(e,a,a+s,t,n,o),k=h[h.length-1],_=Math.min(...h);c.push({dayIndex:a,day:d[0],dayIndexes:u,days:d,values:h,minValue:_,endValue:k,pnl:k-t})}return c}Ne("allocation");const F=document.getElementById("allocation-form"),A=document.getElementById("lower-bound"),S=document.getElementById("upper-bound"),te=document.getElementById("holding-days"),O=document.getElementById("allocation-list"),W=document.getElementById("add-allocation"),Be=document.getElementById("allocation-editor-title"),I=document.getElementById("weights-editor"),x=document.getElementById("allocation-editor-summary"),ne=document.getElementById("save-allocation"),re=document.getElementById("remove-allocation"),g=document.getElementById("allocation-status"),E=document.getElementById("allocation-chart-section"),j=document.getElementById("allocation-chart"),w=document.getElementById("allocation-violin-section"),U=document.getElementById("allocation-violin"),ie=document.querySelectorAll('input[name="currency"]'),Q=document.getElementById("ticker-selection"),he=document.getElementById("ticker-selection-status"),oe="USD",X=1,_e={USD:"constant USD",EUR:"constant EUR"};let y=null,p=[],T=new Set,ce={},pe={},L=oe;const f=[];let v=null,G=!1,Fe=1,R=null,N=null;const ge=20;function V(e,t){var r;if(!(e instanceof HTMLInputElement))return;if(!t){e.value="";return}if(typeof t=="string"&&/^\d{4}-\d{2}-\d{2}$/.test(t)){if(e.value=t,e.value===t)return;const[i,s,o]=t.split("-").map(c=>Number.parseInt(c,10));if([i,s,o].every(Number.isFinite)){const c=new Date(Date.UTC(i,s-1,o));Number.isNaN(c.getTime())||(e.valueAsDate=c)}return}const n=t instanceof Date?t:new Date(t);Number.isNaN((r=n==null?void 0:n.getTime)==null?void 0:r.call(n))?e.value="":e.valueAsDate=n}function z(e){he&&(he.textContent=e??"")}function Re(){if(!Q)return;Q.innerHTML="";const e=Le(y,{selectedTickers:Array.from(T),onSelectionChange:t=>{ze(new Set(t))}});Q.appendChild(e)}function ze(e){T=new Set(e),p=Array.from(T),be(),le()}function je(){I.innerHTML="";const e=document.createElement("p");e.className="weights-editor-empty",e.textContent="Select at least one ticker to configure allocations.",I.appendChild(e),x.textContent="No tickers selected."}function be(){if(f.length=0,v=null,p.length===0){$(),W.disabled=!0,de(!1),je();return}W.disabled=!1;const e=q(ae());p.forEach(t=>{const n={[t]:1};q(n)}),$(),B(e.id,{force:!0})}function Ue(e){if(!y)return null;const t=Ee(e);return t?{days:y.days,price_in_constant_usd:t}:null}function Z(){V(A,""),V(S,""),A&&delete A.dataset.index,S&&delete S.dataset.index}function le(e={}){var s,o;const{triggerRun:t=!0}=e;if(!y||!A||!S)return;const n=Array.from(T);if(n.length===0){N=null,Z(),z("Select at least one ticker to run the simulation."),t&&C();return}const r=Ue(L);if(!r){N=null,Z(),z(`Problem data is missing ${P(L)} prices for the selected tickers.`),t&&C();return}const i=Ie(r,n);if(!i)N=null,Z(),z("Selected tickers do not share a common date range without missing values. Adjust your selection.");else{N=i;const c=((s=r.days)==null?void 0:s[i.startIndex])??"",l=((o=r.days)==null?void 0:o[i.endIndex])??"";V(A,c),V(S,l),A.dataset.index=String(i.startIndex),S.dataset.index=String(i.endIndex),z(`Using ${n.length} ticker(s) from ${c} through ${l}.`)}t&&C()}function Me(e){const t=Number(e);return!Number.isFinite(t)||t<=0?"0":t.toFixed(4).replace(/\.0+$/,"").replace(/(\.\d*?)0+$/,"$1")}function D(e){if(!Number.isFinite(e))return"—";const t=Math.abs(e),n=t<1?2:t<10?1:0;return`${e.toFixed(n)}%`}function Oe(e,t){if(!Array.isArray(e)||e.length===0)return Number.NaN;const n=Math.min(Math.max(t,0),100),r=[...e].sort((u,d)=>u-d);if(r.length===1)return r[0];const i=(r.length-1)*n/100,s=Math.floor(i),o=Math.ceil(i);if(s===o)return r[s];const c=r[s],l=r[o],a=i-s;return c+(l-c)*a}function ee(e){return!Number.isFinite(e)||e===0?"inherit":e>0?"#047857":"#b91c1c"}function se(e){const t={};return Object.entries(e??{}).forEach(([n,r])=>{t[n]=Number(r)||0}),t}function ae(){const e={};if(p.length===0)return e;const t=1/p.length;return p.forEach(n=>{e[n]=t}),e}function We(e){const t={};return p.forEach(n=>{const r=Number(e==null?void 0:e[n]);t[n]=Number.isFinite(r)&&r>0?r:0}),t}function J(e){const t=f.findIndex(o=>o.id===e.id),n=t===-1?f.length+1:t+1,i=Object.entries(e.weights??{}).filter(([,o])=>Number(o)>0).sort((o,c)=>c[1]-o[1]).map(([o,c])=>`${o} ${Math.round(c*100)}%`),s=i.length>0?`${n} ${i.join(" ")}`:`${n} (no weights)`;return s.length>ge?s.slice(0,ge):s}function q(e,{normalize:t=!0}={}){let n=We(e);if(t){const{valid:i,weights:s}=M(n);if(i)n=se(s);else{const{weights:o}=M(ae());n=se(o)}}const r={id:`allocation-${Fe++}`,weights:n};return f.push(r),r.name=J(r),r}function ue(){const e=Array.from(ie??[]).find(n=>n.checked);return((e==null?void 0:e.value)??oe)==="EUR"?"EUR":oe}function P(e){return _e[e]??e}function Ee(e){return pe[e]??null}function Ve(e){const t=Array.isArray(e==null?void 0:e.constant_usd_to_constant_eur)?e.constant_usd_to_constant_eur:[],n=Array.isArray(e==null?void 0:e.days)?e.days:[],r=(e==null?void 0:e.price_in_constant_usd)??{};if(t.length!==n.length||n.length===0)return null;const i={};return Object.entries(r).forEach(([s,o])=>{!Array.isArray(o)||o.length!==n.length||(i[s]=o.map((c,l)=>{const a=typeof c=="number"?c:Number.NaN;if(!Number.isFinite(a)||a<=0)return Number.NaN;const u=typeof t[l]=="number"?t[l]:Number.NaN;if(!Number.isFinite(u)||u<=0){const d=n[l]??`index ${l}`;throw new Error(`Missing constant EUR conversion factor for ${s} on ${d}. Update problem data.`)}return a*u}))}),i}function qe(e){const t=(e==null?void 0:e.price_in_constant_usd)??{},n=Ve(e),r={USD:t};return n&&(r.EUR=n),r}function $(){O.innerHTML="",f.forEach(e=>{const t=J(e);e.name=t;const n=document.createElement("li"),r=document.createElement("button");r.type="button",r.dataset.id=e.id,e.id===v&&r.classList.add("selected");const i=document.createElement("strong");i.textContent=e.name,r.appendChild(i),r.appendChild(document.createElement("br"));const s=document.createElement("small");s.className="allocation-summary";const o=Object.entries(e.weights??{}).sort((c,l)=>l[1]-c[1]);o.length===0?s.textContent="No weights configured":o.forEach(([c,l],a)=>{const u=document.createElement("span");u.textContent=`${c} ${(l*100).toFixed(1)}%`;const d=ce[c];typeof d=="string"&&d.trim()&&(u.title=d.trim(),u.className="ticker-label"),s.appendChild(u),a<o.length-1&&s.appendChild(document.createTextNode(", "))}),r.appendChild(s),n.appendChild(r),O.appendChild(n)}),re.disabled=f.length<=1}function de(e){G=e,ne.disabled=!e}function we(){const e={};return I.querySelectorAll("input[data-ticker]").forEach(n=>{const r=Number(n.value);e[n.dataset.ticker]=Number.isFinite(r)&&r>=0?r:0}),e}function K(){const e=we(),t=Object.values(e).reduce((r,i)=>r+i,0),n=Math.abs(t-1)<.001;return x.textContent=`Current total weight: ${t.toFixed(3)}${n?" (normalized)":""}`,{total:t,normalized:n}}function xe(e){const t=J(e);e.name=t,Be.textContent=t,I.innerHTML="",p.forEach(n=>{const r=document.createElement("div");r.className="weight-row";const i=document.createElement("label");i.className="weight-label";const s=document.createElement("span");s.className="weight-label-text",s.textContent=n;const o=ce[n];typeof o=="string"&&o.trim()&&(i.title=o.trim());const c=document.createElement("input");c.type="number",c.min="0",c.max="1",c.step="any",c.dataset.ticker=n,c.value=Me(e.weights[n]??0),i.appendChild(s),i.appendChild(c),r.appendChild(i),I.appendChild(r)}),de(!1),K()}function B(e,{force:t}={}){if(!t&&G&&e!==v){K(),x.textContent+=" — save the allocation before switching.";return}const n=f.find(r=>r.id===e);n&&(v=n.id,$(),xe(n))}function He(){if(!v)return!1;const e=f.find(s=>s.id===v);if(!e)return!1;const t=we(),{valid:n,weights:r}=M(t);if(!n)return x.textContent="Weights must include at least one positive value before saving.",!1;e.weights=se(r),e.name=J(e),xe(e),$();const{normalized:i}=K();return x.textContent+=i?" — saved allocation.":"",!0}function Ye(){if(f.length<=1)return x.textContent="At least one allocation is required.",!1;const e=f.findIndex(r=>r.id===v);if(e===-1)return!1;f.splice(e,1),$();const t=e>=f.length?f.length-1:e,n=f[t];if(v=(n==null?void 0:n.id)??null,n)B(n.id,{force:!0}),x.textContent="Allocation removed.";else{const r=q(ae());$(),B(r.id,{force:!0})}return!0}function Xe(){if(f.length===0)return;if(G){x.textContent="Save the current allocation before adding a new one.";return}const e={};p.forEach(n=>{e[n]=0});const t=q(e,{normalize:!1});$(),B(t.id,{force:!0}),x.textContent="New allocation created. Adjust weights and save."}function Ge(e,t){if(!j)return;if(!globalThis.Plotly||e.length===0){E&&(E.hidden=!0);return}const n=e.map((s,o)=>{const c=s.map(a=>a.day),l=s.map(a=>a.pnl/X*100);return{name:s.label??`Allocation ${o+1}`,x:c,y:l,type:"scatter",mode:"lines",hovertemplate:"<b>%{x}</b><br />PnL: %{y:.2f}%<extra></extra>"}}),r={title:`Start-Day P&L (${P(t)})`,xaxis:{title:"Start day"},yaxis:{title:"PnL (%)",zeroline:!0,zerolinecolor:"#94a3b8",ticksuffix:"%"},margin:{t:50,r:60,b:60,l:100}},i={responsive:!0};console.debug("renderChart",{count:e.length,labels:n.map(s=>s.name),currency:t}),globalThis.Plotly.react(j,n,r,i),E.hidden=!1,Y(j)}function Je(e,t){if(!U)return;if(!globalThis.Plotly||e.length===0){w&&(w.hidden=!0);return}const n=e.map((o,c)=>o.label??`Allocation ${c+1}`),r=e.map((o,c)=>{const l=o.map(u=>u.pnl/X*100),a=n[c];return{name:a,type:"violin",orientation:"h",x:l,y:Array(l.length).fill(a),hovertemplate:"<b>"+a+"</b><br />PnL: %{x:.2f}%<extra></extra>",box:{visible:!0},meanline:{visible:!0},spanmode:"hard"}}),i={title:`PnL Distribution (${P(t)})`,xaxis:{title:"PnL (%)"},yaxis:{showgrid:!1,zeroline:!1,autorange:"reversed",categoryorder:"array",categoryarray:n,showticklabels:!1},violingap:.2,violingroupgap:.3,margin:{t:50,r:100,b:60,l:160},legend:{orientation:"v",x:1.02,xanchor:"left",y:.5,yanchor:"middle"}},s={responsive:!0};console.debug("renderViolin",{count:e.length,labels:r.map(o=>o.name)}),globalThis.Plotly.react(U,r,i,s),w.hidden=!1,Y(U)}function Ke(e,t){if(!g)return;if(e.length===0){g.textContent="No simulations were run. Adjust the inputs and try again.";return}const n=P(t),r=document.createElement("div");r.textContent=`Simulated ${e[0].length} windows per allocation (${n}).`;const i=document.createElement("table");i.className="allocation-status__table",i.style.marginTop="12px",i.style.borderCollapse="collapse",i.style.minWidth="320px",i.style.maxWidth="720px",i.style.fontSize="0.95rem",i.style.border="1px solid rgba(148, 163, 184, 0.6)";const s=document.createElement("tr");["Allocation","Mean %","Min %","5th %"].forEach((a,u)=>{const d=document.createElement("th");d.scope="col",d.textContent=a,d.style.textAlign=u===0?"left":"right",d.style.padding="6px 10px",d.style.borderBottom="1px solid #cbd5e1",u===0&&(d.style.borderRight="1px solid rgba(148, 163, 184, 0.6)"),s.appendChild(d)});const o=document.createElement("thead");o.appendChild(s),i.appendChild(o);const c=document.createElement("tbody"),l=X;if(e.forEach((a,u)=>{const d=a.label??`Allocation ${u+1}`,h=a.map(m=>m.pnl/l*100).filter(m=>Number.isFinite(m));if(h.length===0)return;const k=h.reduce((m,b)=>m+b,0)/h.length,_=Math.min(...h),fe=Oe(h,5),me=document.createElement("tr");[{text:d,align:"left",scope:"row"},{text:D(k),align:"right",color:ee(k)},{text:D(_),align:"right",color:ee(_)},{text:D(fe),align:"right",color:ee(fe)}].forEach(m=>{const b=document.createElement("td");m.scope&&(b.scope=m.scope),b.style.textAlign=m.align??"right",b.textContent=m.text,b.style.padding="6px 10px",b.style.borderBottom="1px solid rgba(148, 163, 184, 0.5)",m.align==="left"&&(b.style.borderRight="1px solid rgba(148, 163, 184, 0.5)"),m.color&&(b.style.color=m.color),me.appendChild(b)}),c.appendChild(me)}),!c.hasChildNodes()){g.textContent="No simulations were run. Adjust the inputs and try again.";return}i.appendChild(c),g.replaceChildren(r,i)}function H(e){g&&(g.textContent=`Unable to run simulation: ${e.message}`),E&&(E.hidden=!0),w&&(w.hidden=!0)}function C(){R&&clearTimeout(R),R=setTimeout(()=>{R=null,Qe()},200)}async function Qe(){if(y){if(p.length===0){g&&(g.textContent="Select at least one ticker to run the simulation."),E&&(E.hidden=!0),w&&(w.hidden=!0);return}if(G){H(new Error("Save the current allocation before running the simulation."));return}try{const e=X,t=Number.parseInt(te.value,10);if(!Number.isFinite(t)||t<=0)throw new Error("Holding time must be a positive integer");if(!N)throw new Error("Selected tickers do not share a common date range. Adjust your selection.");const n=N.startIndex,r=N.endIndex;if(n>=r)throw new Error("Start day must come before end day");const i=ue();L=i;const s=Ee(i);if(!s||Object.keys(s).length===0)throw new Error(`Problem data missing ${P(i)} price series`);const o=[];f.forEach(c=>{const{valid:l,weights:a}=M(c.weights);if(!l)return;const u=ke(y,e,a,n,r,t,s);u.length>0&&(u.label=c.name,o.push(u))}),console.debug("plottedSeries",o.map(c=>({label:c.label,points:c.length})),{currency:i}),Ke(o,i),Ge(o,i),Je(o,i)}catch(e){H(e)}}}function Ze(e){y=e,Ce(y);const t=Ae(y);T=new Set(t),p=Array.from(T),ce=Se(y),pe=qe(y),L=ue(),Re(),N=null,be(),le({triggerRun:!1}),g&&(g.textContent=`Simulation ready using ${P(L)}.`)}async function ye(){if(!F||!A||!S||!te||!O||!W||!I||!ne||!re||ie.length===0){H(new Error("Allocation form inputs not found"));return}try{const e=await ve();Ze(e),C(),F.addEventListener("submit",t=>{t.preventDefault()}),O.addEventListener("click",t=>{const n=t.target.closest("button[data-id]");n&&B(n.dataset.id)}),I.addEventListener("input",t=>{t.target instanceof HTMLInputElement&&t.target.dataset.ticker&&(de(!0),K())}),W.addEventListener("click",()=>{Xe()}),ne.addEventListener("click",()=>{He()&&C()}),re.addEventListener("click",()=>{Ye()&&C()}),te.addEventListener("change",C),ie.forEach(t=>{t.addEventListener("change",()=>{L=ue(),g&&(g.textContent=`Currency switched to ${P(L)}. Updating results...`),E&&(E.hidden=!0),w&&(w.hidden=!0),le()})}),window.addEventListener("resize",()=>{Y(j),Y(U)})}catch(e){H(e),F&&F.querySelectorAll("button, input").forEach(t=>{t.disabled=!0})}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ye):ye();function Y(e){var n,r;if(!e||!((r=(n=globalThis.Plotly)==null?void 0:n.Plots)!=null&&r.resize))return;const t=()=>{try{globalThis.Plotly.Plots.resize(e)}catch{}};typeof window<"u"&&window.requestAnimationFrame?window.requestAnimationFrame(t):setTimeout(t,0)}
