import{i as Ce}from"./navigation-CXrC8Ner.js";import{r as Ae,e as Se}from"./markdown-BYZln54M.js";import{f as Ie,g as Le,c as $e,a as Te,d as Pe}from"./problemView-B6EqPGeH.js";function U(e){let t=0;const n={};for(const[i,c]of Object.entries(e??{})){const a=Number(c);Number.isFinite(a)&&a>=0&&(n[i]=a,t+=a)}if(t<=0)return{valid:!1,weights:{}};const r={};Object.entries(n).forEach(([i,c])=>{r[i]=c/t});const o=Object.values(r).reduce((i,c)=>i+c,0);return{valid:Math.abs(o-1)<1e-6,weights:r}}function ke(e,t,n,r){if(!Number.isFinite(e)||e<=0)throw new Error("startCapital must be positive");if(!Number.isInteger(r)||r<0)throw new Error("startIndex must be a non-negative integer");const o={};for(const[s,i]of Object.entries(t??{})){if(!Number.isFinite(i)||i<=0)continue;const c=n==null?void 0:n[s];if(!Array.isArray(c))throw new Error(`missing price series for ${s}`);const a=Number(c[r]);if(!Number.isFinite(a)||a<=0)throw new Error(`invalid price for ${s} on index ${r}`);o[s]=e*i/a}if(Object.keys(o).length===0)throw new Error("no positions created from weights");return o}function Be(e,t,n){if(!Number.isInteger(n)||n<0)throw new Error("dayIndex must be a non-negative integer");let r=0;for(const[o,s]of Object.entries(e??{})){if(!Number.isFinite(s)||s<0)throw new Error(`invalid amount for ${o}`);const i=t==null?void 0:t[o];if(!Array.isArray(i))throw new Error(`missing price series for ${o}`);const c=Number(i[n]);if(!Number.isFinite(c))throw new Error(`invalid price for ${o} on index ${n}`);r+=s*c}return r}function _e(e,t,n,r,o,s){if(!e||!Array.isArray(e.days))throw new Error("invalid problem data");if(!Number.isInteger(t)||!Number.isInteger(n))throw new Error("startIndex and endIndex must be integers");if(t<0||n>=e.days.length)throw new Error("index range out of bounds");if(n<t)throw new Error("endIndex must be >= startIndex");const i=s??e.price_in_constant_usd;if(!i||typeof i!="object")throw new Error("missing price data for simulation");const c=ke(r,o,i,t),a=[],l=[],u=[];for(let d=t;d<=n;d+=1){const h=Be(c,i,d);a.push(d),l.push(e.days[d]),u.push(h)}return{dayIndexes:a,days:l,values:u}}function Fe(e,t,n,r,o,s,i){var a;if(!Number.isInteger(s)||s<=0)return[];if(!Number.isInteger(r)||!Number.isInteger(o))return[];if(r<0||o>=(((a=e==null?void 0:e.days)==null?void 0:a.length)??0))return[];if(!e||!Array.isArray(e.days))return[];const c=[];for(let l=r;l<o-s;l+=1){const{dayIndexes:u,days:d,values:h}=_e(e,l,l+s,t,n,i),k=h[h.length-1],_=Math.min(...h);c.push({dayIndex:l,day:d[0],dayIndexes:u,days:d,values:h,minValue:_,endValue:k,pnl:k-t})}return c}Ce("allocation");const F=document.getElementById("allocation-form"),A=document.getElementById("lower-bound"),S=document.getElementById("upper-bound"),ne=document.getElementById("holding-days"),O=document.getElementById("allocation-list"),W=document.getElementById("add-allocation"),Re=document.getElementById("allocation-editor-title"),I=document.getElementById("weights-editor"),x=document.getElementById("allocation-editor-summary"),re=document.getElementById("save-allocation"),oe=document.getElementById("remove-allocation"),g=document.getElementById("allocation-status"),E=document.getElementById("allocation-chart-section"),M=document.getElementById("allocation-chart"),w=document.getElementById("allocation-violin-section"),j=document.getElementById("allocation-violin"),ie=document.querySelectorAll('input[name="currency"]'),Q=document.getElementById("ticker-selection"),ge=document.getElementById("ticker-selection-status"),Z=document.getElementById("allocation-description-content"),se="USD",X=1,ze={USD:"constant USD",EUR:"constant EUR"};let b=null,pe=[],p=[],P=new Set,ae={},Ee={},L=se;const f=[];let N=null,G=!1,Me=1,R=null,v=null;const ye=20;async function je(){if(Z)try{const e=await fetch("allocation.md",{headers:{Accept:"text/plain"}});if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.text(),n=Ae(t);Z.innerHTML=n||"<p>Overview not available.</p>"}catch(e){Z.innerHTML=`<p>Error loading overview: ${Se(e.message)}</p>`}}je();function H(e,t){var r;if(!(e instanceof HTMLInputElement))return;if(!t){e.value="";return}if(typeof t=="string"&&/^\d{4}-\d{2}-\d{2}$/.test(t)){if(e.value=t,e.value===t)return;const[o,s,i]=t.split("-").map(c=>Number.parseInt(c,10));if([o,s,i].every(Number.isFinite)){const c=new Date(Date.UTC(o,s-1,i));Number.isNaN(c.getTime())||(e.valueAsDate=c)}return}const n=t instanceof Date?t:new Date(t);Number.isNaN((r=n==null?void 0:n.getTime)==null?void 0:r.call(n))?e.value="":e.valueAsDate=n}function z(e){ge&&(ge.textContent=e??"")}function Ue(){if(!Q)return;Q.innerHTML="";const e=Pe(b,{selectedTickers:Array.from(P),onSelectionChange:t=>{Oe(new Set(t))}});Q.appendChild(e)}function Oe(e){P=new Set(e),p=Array.from(P),we(),le()}function We(){I.innerHTML="";const e=document.createElement("p");e.className="weights-editor-empty",e.textContent="Select at least one ticker to configure allocations.",I.appendChild(e),x.textContent="No tickers selected."}function we(){if(f.length=0,N=null,p.length===0){$(),W.disabled=!0,fe(!1),We();return}W.disabled=!1;const e=V(ue());p.forEach(t=>{const n={[t]:1};V(n)}),$(),B(e.id,{force:!0})}function He(e){if(!b)return null;const t=xe(e);return t?{days:b.days,price_in_constant_usd:t}:null}function D(){H(A,""),H(S,""),A&&delete A.dataset.index,S&&delete S.dataset.index}function le(e={}){var s,i;const{triggerRun:t=!0}=e;if(!b||!A||!S)return;const n=Array.from(P);if(n.length===0){v=null,D(),z("Select at least one ticker to run the simulation."),t&&C();return}const r=He(L);if(!r){v=null,D(),z(`Problem data is missing ${T(L)} prices for the selected tickers.`),t&&C();return}const o=Te(r,n);if(!o)v=null,D(),z("Selected tickers do not share a common date range without missing values. Adjust your selection.");else{v=o;const c=((s=r.days)==null?void 0:s[o.startIndex])??"",a=((i=r.days)==null?void 0:i[o.endIndex])??"";H(A,c),H(S,a),A.dataset.index=String(o.startIndex),S.dataset.index=String(o.endIndex),z(`Using ${n.length} ticker(s) from ${c} through ${a}.`)}t&&C()}function Ve(e){const t=Number(e);return!Number.isFinite(t)||t<=0?"0":t.toFixed(4).replace(/\.0+$/,"").replace(/(\.\d*?)0+$/,"$1")}function ee(e){if(!Number.isFinite(e))return"—";const t=Math.abs(e),n=t<1?2:t<10?1:0;return`${e.toFixed(n)}%`}function qe(e,t){if(!Array.isArray(e)||e.length===0)return Number.NaN;const n=Math.min(Math.max(t,0),100),r=[...e].sort((u,d)=>u-d);if(r.length===1)return r[0];const o=(r.length-1)*n/100,s=Math.floor(o),i=Math.ceil(o);if(s===i)return r[s];const c=r[s],a=r[i],l=o-s;return c+(a-c)*l}function te(e){return!Number.isFinite(e)||e===0?"inherit":e>0?"#047857":"#b91c1c"}function ce(e){const t={};return Object.entries(e??{}).forEach(([n,r])=>{t[n]=Number(r)||0}),t}function ue(){const e={};if(p.length===0)return e;const t=1/p.length;return p.forEach(n=>{e[n]=t}),e}function Ye(e){const t={};return p.forEach(n=>{const r=Number(e==null?void 0:e[n]);t[n]=Number.isFinite(r)&&r>0?r:0}),t}function J(e){const t=f.findIndex(i=>i.id===e.id),n=t===-1?f.length+1:t+1,o=Object.entries(e.weights??{}).filter(([,i])=>Number(i)>0).sort((i,c)=>c[1]-i[1]).map(([i,c])=>`${i} ${Math.round(c*100)}%`),s=o.length>0?`${n} ${o.join(" ")}`:`${n} (no weights)`;return s.length>ye?s.slice(0,ye):s}function V(e,{normalize:t=!0}={}){let n=Ye(e);if(t){const{valid:o,weights:s}=U(n);if(o)n=ce(s);else{const{weights:i}=U(ue());n=ce(i)}}const r={id:`allocation-${Me++}`,weights:n};return f.push(r),r.name=J(r),r}function de(){const e=Array.from(ie??[]).find(n=>n.checked);return((e==null?void 0:e.value)??se)==="EUR"?"EUR":se}function T(e){return ze[e]??e}function xe(e){return Ee[e]??null}function Xe(e){const t=Array.isArray(e==null?void 0:e.constant_usd_to_constant_eur)?e.constant_usd_to_constant_eur:[],n=Array.isArray(e==null?void 0:e.days)?e.days:[],r=(e==null?void 0:e.price_in_constant_usd)??{};if(t.length!==n.length||n.length===0)return null;const o={};return Object.entries(r).forEach(([s,i])=>{!Array.isArray(i)||i.length!==n.length||(o[s]=i.map((c,a)=>{const l=typeof c=="number"?c:Number.NaN;if(!Number.isFinite(l)||l<=0)return Number.NaN;const u=typeof t[a]=="number"?t[a]:Number.NaN;if(!Number.isFinite(u)||u<=0){const d=n[a]??`index ${a}`;throw new Error(`Missing constant EUR conversion factor for ${s} on ${d}. Update problem data.`)}return l*u}))}),o}function Ge(e){const t=(e==null?void 0:e.price_in_constant_usd)??{},n=Xe(e),r={USD:t};return n&&(r.EUR=n),r}function $(){O.innerHTML="",f.forEach(e=>{const t=J(e);e.name=t;const n=document.createElement("li"),r=document.createElement("button");r.type="button",r.dataset.id=e.id,e.id===N&&r.classList.add("selected");const o=document.createElement("strong");o.textContent=e.name,r.appendChild(o),r.appendChild(document.createElement("br"));const s=document.createElement("small");s.className="allocation-summary";const i=Object.entries(e.weights??{}).sort((c,a)=>a[1]-c[1]);i.length===0?s.textContent="No weights configured":i.forEach(([c,a],l)=>{const u=document.createElement("span");u.textContent=`${c} ${(a*100).toFixed(1)}%`;const d=ae[c];typeof d=="string"&&d.trim()&&(u.title=d.trim(),u.className="ticker-label"),s.appendChild(u),l<i.length-1&&s.appendChild(document.createTextNode(", "))}),r.appendChild(s),n.appendChild(r),O.appendChild(n)}),oe.disabled=f.length<=1}function fe(e){G=e,re.disabled=!e}function ve(){const e={};return I.querySelectorAll("input[data-ticker]").forEach(n=>{const r=Number(n.value);e[n.dataset.ticker]=Number.isFinite(r)&&r>=0?r:0}),e}function K(){const e=ve(),t=Object.values(e).reduce((r,o)=>r+o,0),n=Math.abs(t-1)<.001;return x.textContent=`Current total weight: ${t.toFixed(3)}${n?" (normalized)":""}`,{total:t,normalized:n}}function Ne(e){const t=J(e);e.name=t,Re.textContent=t,I.innerHTML="",p.forEach(n=>{const r=document.createElement("div");r.className="weight-row";const o=document.createElement("label");o.className="weight-label";const s=document.createElement("span");s.className="weight-label-text",s.textContent=n;const i=ae[n];typeof i=="string"&&i.trim()&&(o.title=i.trim());const c=document.createElement("input");c.type="number",c.min="0",c.max="1",c.step="any",c.dataset.ticker=n,c.value=Ve(e.weights[n]??0),o.appendChild(s),o.appendChild(c),r.appendChild(o),I.appendChild(r)}),fe(!1),K()}function B(e,{force:t}={}){if(!t&&G&&e!==N){K(),x.textContent+=" — save the allocation before switching.";return}const n=f.find(r=>r.id===e);n&&(N=n.id,$(),Ne(n))}function Je(){if(!N)return!1;const e=f.find(s=>s.id===N);if(!e)return!1;const t=ve(),{valid:n,weights:r}=U(t);if(!n)return x.textContent="Weights must include at least one positive value before saving.",!1;e.weights=ce(r),e.name=J(e),Ne(e),$();const{normalized:o}=K();return x.textContent+=o?" — saved allocation.":"",!0}function Ke(){if(f.length<=1)return x.textContent="At least one allocation is required.",!1;const e=f.findIndex(r=>r.id===N);if(e===-1)return!1;f.splice(e,1),$();const t=e>=f.length?f.length-1:e,n=f[t];if(N=(n==null?void 0:n.id)??null,n)B(n.id,{force:!0}),x.textContent="Allocation removed.";else{const r=V(ue());$(),B(r.id,{force:!0})}return!0}function Qe(){if(f.length===0)return;if(G){x.textContent="Save the current allocation before adding a new one.";return}const e={};p.forEach(n=>{e[n]=0});const t=V(e,{normalize:!1});$(),B(t.id,{force:!0}),x.textContent="New allocation created. Adjust weights and save."}function Ze(e,t){if(!M)return;if(!globalThis.Plotly||e.length===0){E&&(E.hidden=!0);return}const n=e.map((s,i)=>{const c=s.map(l=>l.day),a=s.map(l=>l.pnl/X*100);return{name:s.label??`Allocation ${i+1}`,x:c,y:a,type:"scatter",mode:"lines",hovertemplate:"<b>%{x}</b><br />PnL: %{y:.2f}%<extra></extra>"}}),r={title:`Start-Day P&L (${T(t)})`,xaxis:{title:"Start day"},yaxis:{title:"PnL (%)",zeroline:!0,zerolinecolor:"#94a3b8",ticksuffix:"%"},margin:{t:50,r:60,b:60,l:100}},o={responsive:!0};console.debug("renderChart",{count:e.length,labels:n.map(s=>s.name),currency:t}),globalThis.Plotly.react(M,n,r,o),E.hidden=!1,Y(M)}function De(e,t){if(!j)return;if(!globalThis.Plotly||e.length===0){w&&(w.hidden=!0);return}const n=e.map((i,c)=>i.label??`Allocation ${c+1}`),r=e.map((i,c)=>{const a=i.map(u=>u.pnl/X*100),l=n[c];return{name:l,type:"violin",orientation:"h",x:a,y:Array(a.length).fill(l),hovertemplate:"<b>"+l+"</b><br />PnL: %{x:.2f}%<extra></extra>",box:{visible:!0},meanline:{visible:!0},spanmode:"hard"}}),o={title:`PnL Distribution (${T(t)})`,xaxis:{title:"PnL (%)"},yaxis:{showgrid:!1,zeroline:!1,autorange:"reversed",categoryorder:"array",categoryarray:n,showticklabels:!1},violingap:.2,violingroupgap:.3,margin:{t:50,r:100,b:60,l:160},legend:{orientation:"v",x:1.02,xanchor:"left",y:.5,yanchor:"middle"}},s={responsive:!0};console.debug("renderViolin",{count:e.length,labels:r.map(i=>i.name)}),globalThis.Plotly.react(j,r,o,s),w.hidden=!1,Y(j)}function et(e,t){if(!g)return;if(e.length===0){g.textContent="No simulations were run. Adjust the inputs and try again.";return}const n=T(t),r=document.createElement("div");r.textContent=`Simulated ${e[0].length} windows per allocation (${n}).`;const o=document.createElement("table");o.className="allocation-status__table",o.style.marginTop="12px",o.style.borderCollapse="collapse",o.style.minWidth="320px",o.style.maxWidth="720px",o.style.fontSize="0.95rem",o.style.border="1px solid rgba(148, 163, 184, 0.6)";const s=document.createElement("tr");["Allocation","Mean %","Min %","5th %"].forEach((l,u)=>{const d=document.createElement("th");d.scope="col",d.textContent=l,d.style.textAlign=u===0?"left":"right",d.style.padding="6px 10px",d.style.borderBottom="1px solid #cbd5e1",u===0&&(d.style.borderRight="1px solid rgba(148, 163, 184, 0.6)"),s.appendChild(d)});const i=document.createElement("thead");i.appendChild(s),o.appendChild(i);const c=document.createElement("tbody"),a=X;if(e.forEach((l,u)=>{const d=l.label??`Allocation ${u+1}`,h=l.map(m=>m.pnl/a*100).filter(m=>Number.isFinite(m));if(h.length===0)return;const k=h.reduce((m,y)=>m+y,0)/h.length,_=Math.min(...h),me=qe(h,5),he=document.createElement("tr");[{text:d,align:"left",scope:"row"},{text:ee(k),align:"right",color:te(k)},{text:ee(_),align:"right",color:te(_)},{text:ee(me),align:"right",color:te(me)}].forEach(m=>{const y=document.createElement("td");m.scope&&(y.scope=m.scope),y.style.textAlign=m.align??"right",y.textContent=m.text,y.style.padding="6px 10px",y.style.borderBottom="1px solid rgba(148, 163, 184, 0.5)",m.align==="left"&&(y.style.borderRight="1px solid rgba(148, 163, 184, 0.5)"),m.color&&(y.style.color=m.color),he.appendChild(y)}),c.appendChild(he)}),!c.hasChildNodes()){g.textContent="No simulations were run. Adjust the inputs and try again.";return}o.appendChild(c),g.replaceChildren(r,o)}function q(e){g&&(g.textContent=`Unable to run simulation: ${e.message}`),E&&(E.hidden=!0),w&&(w.hidden=!0)}function C(){R&&clearTimeout(R),R=setTimeout(()=>{R=null,tt()},200)}async function tt(){if(b){if(p.length===0){g&&(g.textContent="Select at least one ticker to run the simulation."),E&&(E.hidden=!0),w&&(w.hidden=!0);return}if(G){q(new Error("Save the current allocation before running the simulation."));return}try{const e=X,t=Number.parseInt(ne.value,10);if(!Number.isFinite(t)||t<=0)throw new Error("Holding time must be a positive integer");if(!v)throw new Error("Selected tickers do not share a common date range. Adjust your selection.");const n=v.startIndex,r=v.endIndex;if(n>=r)throw new Error("Start day must come before end day");const o=de();L=o;const s=xe(o);if(!s||Object.keys(s).length===0)throw new Error(`Problem data missing ${T(o)} price series`);const i=[];f.forEach(c=>{const{valid:a,weights:l}=U(c.weights);if(!a)return;const u=Fe(b,e,l,n,r,t,s);u.length>0&&(u.label=c.name,i.push(u))}),console.debug("plottedSeries",i.map(c=>({label:c.label,points:c.length})),{currency:o}),et(i,o),Ze(i,o),De(i,o)}catch(e){q(e)}}}function nt(e){b=e,pe=Le(b),P=new Set(pe),p=Array.from(P),ae=$e(b),Ee=Ge(b),L=de(),Ue(),v=null,we(),le({triggerRun:!1}),g&&(g.textContent=`Simulation ready using ${T(L)}.`)}async function be(){if(!F||!A||!S||!ne||!O||!W||!I||!re||!oe||ie.length===0){q(new Error("Allocation form inputs not found"));return}try{const e=await Ie();nt(e),C(),F.addEventListener("submit",t=>{t.preventDefault()}),O.addEventListener("click",t=>{const n=t.target.closest("button[data-id]");n&&B(n.dataset.id)}),I.addEventListener("input",t=>{t.target instanceof HTMLInputElement&&t.target.dataset.ticker&&(fe(!0),K())}),W.addEventListener("click",()=>{Qe()}),re.addEventListener("click",()=>{Je()&&C()}),oe.addEventListener("click",()=>{Ke()&&C()}),ne.addEventListener("change",C),ie.forEach(t=>{t.addEventListener("change",()=>{L=de(),g&&(g.textContent=`Currency switched to ${T(L)}. Updating results...`),E&&(E.hidden=!0),w&&(w.hidden=!0),le()})}),window.addEventListener("resize",()=>{Y(M),Y(j)})}catch(e){q(e),F&&F.querySelectorAll("button, input").forEach(t=>{t.disabled=!0})}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",be):be();function Y(e){var n,r;if(!e||!((r=(n=globalThis.Plotly)==null?void 0:n.Plots)!=null&&r.resize))return;const t=()=>{try{globalThis.Plotly.Plots.resize(e)}catch{}};typeof window<"u"&&window.requestAnimationFrame?window.requestAnimationFrame(t):setTimeout(t,0)}
